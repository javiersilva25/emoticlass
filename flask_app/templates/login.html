{% extends "base.html" %}
{% block title %}Ingresar — Emoticlass{% endblock %}

{% block content %}
<div class="min-h-[70vh] flex items-center justify-center">
  <div class="w-full max-w-md bg-white shadow-xl rounded-2xl p-6">
    <h1 class="text-xl font-semibold text-gray-800 text-center mb-4">
      Sistema de análisis de emociones
    </h1>

    {% if error %}
      <div class="mb-4 rounded-md border border-red-200 bg-red-50 p-3 text-red-800 text-sm">
        {{ error }}
      </div>
    {% endif %}

    <form method="POST" action="{{ url_for('auth.login') }}" class="space-y-4">
      <div>
        <label for="rut" class="block text-sm font-medium text-gray-700 mb-1">RUT</label>
        <input type="text" id="rut" name="rut" placeholder="12.345.678-9" required
               class="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900
                      focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
      </div>

      <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
        <input type="password" id="password" name="password" required
               class="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900
                      focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
      </div>

      <button type="submit" class="btn-primary">
        Iniciar sesión
      </button>
    </form>

    <div class="mt-5 text-center text-sm text-gray-600">
      ¿No tienes cuenta?
      <a href="{{ url_for('auth.register') }}" class="text-teal-600 hover:underline">Regístrate aquí</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // --- Formatear RUT ---
  function formatRUT(rut) {
    rut = rut.replace(/\./g, '').replace(/-/g, '');
    if (!/^[0-9]+[0-9kK]?$/.test(rut)) return rut;
    let num = rut.slice(0, -1), dv = rut.slice(-1).toUpperCase();
    num = num.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return num + '-' + dv;
  }
  // --- Validar RUT ---
  function validateRUT(rut) {
    rut = rut.replace(/\./g, '').replace(/-/g, '');
    if (rut.length < 2) return false;
    let num = rut.slice(0, -1), dv = rut.slice(-1).toUpperCase();
    let sum = 0, mul = 2;
    for (let i = num.length - 1; i >= 0; i--) {
      sum += parseInt(num[i]) * mul;
      mul = (mul === 7) ? 2 : mul + 1;
    }
    let calc = 11 - (sum % 11);
    calc = (calc === 11) ? '0' : (calc === 10 ? 'K' : calc.toString());
    return dv === calc;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input[type="text"], input[type="password"]');
    const rutInput = document.getElementById('rut');

    inputs.forEach(input => {
      input.addEventListener('focus', () => input.style.transform = 'translateY(-2px)');
      input.addEventListener('blur',  () => input.style.transform = 'translateY(0)');
    });

    rutInput.addEventListener('input', function() {
      const pos = this.selectionStart;
      const oldLen = this.value.length;
      this.value = formatRUT(this.value);
      const diff = this.value.length - oldLen;
      this.setSelectionRange(pos + diff, pos + diff);
    });

    rutInput.addEventListener('blur', function() {
      const existing = this.parentNode.querySelector('.rut-error');
      if (this.value && !validateRUT(this.value)) {
        this.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
        if (!existing) {
          const small = document.createElement('small');
          small.className = 'rut-error text-red-600';
          small.textContent = 'RUT inválido';
          this.parentNode.appendChild(small);
        }
      } else {
        this.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
        if (existing) existing.remove();
      }
    });

    rutInput.focus();
  });
</script>
{% endblock %}
